# AI Agent 开发规范

## 1. 安全与隐私

- **P1 禁止泄露敏感信息**：agent 不得输出或保存用户的密码、私钥、信用卡号、身份证号等敏感数据的明文。  
- **P2 最小权限原则**：任何对外 API、数据库、文件系统的访问必须通过最小权限凭证并记录调用上下文（agent id、请求 id、时间戳）。  
- **P3 数据脱敏**：存储或展示历史交互时，必须对个人识别信息（PII）进行脱敏或摘要化处理。  
- **P4 加密要求**：传输层使用 TLS；静态数据使用 AES-256 或等效方案加密。

## 2. 行为约束与输出质量
- **Q1 事实核查**：当 agent 给出事实性断言且概率低于阈值（默认 85%）时，必须附带来源或标注“未经验证”。  
- **Q2 禁止有害行为**：不执行或指导任何违法、攻击性、危险或规避安全控制的操作。  
- **Q3 输出格式化**：所有机器可读输出需提供 `structured` 字段（JSON schema 约束）。  
- **Q4 置信度与元数据**：每次响应必须附带置信度分数、使用的工具名与上下文片段引用（if available）。

## 3. 资源与性能
- **R1 超时**：单次任务最长执行时限（soft）为 30s，(hard) 为 120s，超过 soft 应优雅降级并回报部分结果。  
- **R2 并发限制**：同一 agent 实例并发任务上限（默认 10），超出应排队或触发横向扩容。  
- **R3 成本控制**：对外调用计费接口必须走费用预估与上限保护。

## 4. 可解释性与审计
- **A1 可复制性**：重要决策需记录输入、模型版本、工具版本与随机种子（如适用），以支持事后复现。  
- **A2 决策链摘要**：对高风险决定必须提供人类可理解的 1–3 行理由摘要（非完整内置推理）。  
- **A3 审计日志保留期**：操作日志与决策记录最低保留 90 天，合规要求更长者以合规标准为准。

## 5. 错误/重试策略
- **E1 错误分级**：分为 transient、recoverable、fatal 三类。  
- **E2 重试限制**：transient 错误自动重试上限 3 次，指数退避；recoverable 需人工介入或 human-in-loop。  
- **E3 失败回滚**：有副作用操作必须实现幂等与补偿事务。

## 6. 人类在环（HITL）
- **H1 阈值触发**：当置信度低于 70% 或决策属高风险类别时自动转交人工审核。  
- **H2 审核界面要求**：展示原始上下文、模型输出、置信度、推荐操作和“撤销/批准”按钮。

## 7. 合规与日志
- **C1 合规标注**：在涉及监管领域（财务、医疗、法律）时标注适用法规。  
- **C2 日志结构**：使用统一 schema（timestamp、agent_id、request_id、user_id_hash、action、outcome、metadata）。

## 8. 变更与发布
- **V1 模型/规则变更需走审批**：包含回归测试、风险评估与灰度发布计划（至少 3% 流量观察 48 小时）。  
- **V2 回滚条件**：关键错误率上升 > 2x 或用户投诉率超过阈值时必须自动回滚。

---

## 附录：示例 Rule YAML（可机器解析）
```yaml
id: rule-secrets-leak
title: "禁止明文输出敏感信息"
severity: critical
condition:
  any:
    - output_contains: ["credit_card", "ssn", "private_key"]
action:
  - redact_field: true
  - escalate: security-team
